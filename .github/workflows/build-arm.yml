name: Build ARM Binary

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    name: Build ARMv7
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ARMv7 binary with Docker
        run: |
          docker build \
            --platform linux/arm/v7 \
            -f .github/Dockerfile.arm \
            -t kindle-hid-passthrough-builder \
            --load \
            .

      - name: Extract binaries
        run: |
          CONTAINER_ID=$(docker create kindle-hid-passthrough-builder)
          mkdir -p output/dist

          # Extract C wrapper and syscall shim
          docker cp "$CONTAINER_ID:/build/kindle-hid-passthrough" ./output/kindle-hid-passthrough
          docker cp "$CONTAINER_ID:/build/libsyscall_wrapper.so" ./output/libsyscall_wrapper.so

          # Extract entire Nuitka standalone dist directory (includes ld-linux + all .so deps)
          docker cp "$CONTAINER_ID:/build/nuitka-out/main.dist/." ./output/dist/

          docker rm "$CONTAINER_ID"
          chmod +x output/kindle-hid-passthrough output/dist/main.bin output/dist/ld-linux-armhf.so.3

      - name: Add config files
        run: |
          cp kindle_hid_passthrough/hid-passthrough.upstart output/
          cp kindle_hid_passthrough/config.ini output/

      - name: Show contents
        run: |
          echo "=== Top level ==="
          ls -lh output/
          echo "=== dist/ ==="
          ls -lh output/dist/ | head -30
          echo "=== File types ==="
          file output/kindle-hid-passthrough output/dist/main.bin output/dist/ld-linux-armhf.so.3

      - name: Create tarball
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF_NAME}"
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          tar -czvf "kindle-hid-passthrough-${VERSION}-armv7.tar.gz" -C output .
          ls -lh *.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kindle-hid-passthrough-armv7
          path: |
            output/
            *.tar.gz

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: kindle-hid-passthrough-${{ github.ref_name }}-armv7.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
